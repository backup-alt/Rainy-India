name: India News Monitor (Final Cloud Version)

on:
  workflow_dispatch: # Manual button
  schedule:
    - cron: '15,45 * * * *' # Automatic run every 30 mins

jobs:
  monitor:
    runs-on: ubuntu-latest # Uses GitHub's free cloud servers
    strategy:
      fail-fast: false
      max-parallel: 4 # Processes 4 channels at once
      matrix:
        include:
          - { name: "Thanthi", id: "j1nzTy5q_1Y" }
          - { name: "Polimer", id: "Ei6NUWLQCQM" }

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          python3 -m pip install yt-dlp

      - name: Capture and Signal
        env:
          ZOHO_CODE: ${{ secrets.ZOHO_DIGEST }}
          COOKIES: ${{ secrets.YT_COOKIES }}
          UA: ${{ secrets.USER_AGENT }}
          PO: ${{ secrets.PO_DATA }}
        run: |
          NAME="${{ matrix.name }}"
          ID="${{ matrix.id }}"
          
          # 1. Create temporary cookies file
          echo "$COOKIES" > youtube_cookies.txt

          # 2. Advanced Bypass Capture
          # Uses User-Agent, Cookies, and PO Token to look like a human browser
          URL=$(python3 -m yt_dlp \
            --cookies youtube_cookies.txt \
            --user-agent "$UA" \
            --extractor-args "youtube:player_client=ios,web_embedded;po_token=$PO" \
            -f best -g "https://www.youtube.com/watch?v=$ID" --no-warnings)

          if [ ! -z "$URL" ]; then
              echo "Streaming $NAME..."
              # Capture 15 seconds, crop to news ticker area
              ffmpeg -i "$URL" -vf "fps=0.4,scale=800:-1,crop=800:100:0:380" -t 15 -q:v 5 "shot_%03d.jpg"
              
              # 3. Send to Zoho Signal
              for img in shot_*.jpg; do
                  b64_data=$(base64 -w 0 "$img")
                  curl -X POST "https://api.catalyst.zoho.in/signals/v2/event_notification?digest=$ZOHO_CODE" \
                  -H "Content-Type: application/json" \
                  -d "{\"data\": {\"image\": \"$b64_data\", \"channel\": \"$NAME\"}}"
                  sleep 2
              done
          else
              echo "Error: Bot check failed for $NAME. Check your Cookies/PO Token."
              exit 1
          fi
          
          # Cleanup sensitive data
          rm youtube_cookies.txt

      - name: Archive Local Backup
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-frames
          path: shot_*.jpg
          retention-days: 1
