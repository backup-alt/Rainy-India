name: News Cameraman (Creator Mode)

on: 
  workflow_dispatch:
    inputs:
      duration:
        description: 'How long to watch? (seconds)'
        default: '3600'

jobs:
  watch-news:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - uses: actions/checkout@v3

    # 1. Install Tools
    - name: Install Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg python3-pip
        # Install yt-dlp via pip to get the absolute latest nightly build
        sudo pip3 install -U "yt-dlp[default]" --break-system-packages

    # 2. Find the Stream (Trying 'Android Creator' Bypass)
    - name: Get Stream URL
      id: get_stream
      run: |
        YOUTUBE_URL="https://www.youtube.com/@ThanthiTV/live"
        echo "ðŸ” Attempting to extract stream..."
        
        # STRATEGY 1: Use 'android_creator' client (Often bypasses bot checks)
        STREAM_URL=$(yt-dlp --extractor-args "youtube:player_client=android_creator" -f 94/93/95/best -g "$YOUTUBE_URL" || true)
        
        # STRATEGY 2: If Strategy 1 failed, try the 'web' client with a fake User Agent
        if [ -z "$STREAM_URL" ]; then
           echo "âš ï¸ Strategy 1 failed. Trying Strategy 2 (Web Client)..."
           STREAM_URL=$(yt-dlp --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36" -f 94/93/95/best -g "$YOUTUBE_URL")
        fi
        
        if [ -z "$STREAM_URL" ]; then
           echo "âŒ All strategies failed. YouTube is blocking GitHub IPs."
           exit 1
        fi

        echo "âœ… Found Stream!"
        echo "STREAM_URL=$STREAM_URL" >> $GITHUB_ENV

    # 3. Start Capture (Cropped Bottom Bar)
    - name: Capture Screenshots
      run: |
        echo "ðŸ“¸ Starting Capture (Bottom News Bar Only)..."
        
        # One-line command
        ffmpeg -headers "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)" -i "$STREAM_URL" -vf "fps=0.4,scale=854:480,crop=854:120:0:360" -t ${{ inputs.duration }} -q:v 5 screenshot_%04d.jpg

    # 4. Upload Evidence
    - name: Upload Evidence
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: thanthi-tv-evidence
        path: "*.jpg"
