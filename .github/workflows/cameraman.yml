name: News Cameraman (Creator Mode)

on: 
  workflow_dispatch:
    inputs:
      duration:
        description: 'How long to watch? (seconds)'
        default: '3600'

jobs:
  watch-news:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - uses: actions/checkout@v3

    # 1. Install Node.js (Critical for solving puzzles)
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    # 2. Install Tools (FFmpeg + Latest yt-dlp via Python)
    - name: Install Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg python3-pip
        # Force install the absolute latest yt-dlp
        sudo pip3 install -U "yt-dlp[default]" --break-system-packages

    # 3. Find the Stream (Using Android Creator Client)
    - name: Get Stream URL
      id: get_stream
      run: |
        YOUTUBE_URL="https://www.youtube.com/@ThanthiTV/live"
        echo "ðŸ” Looking for stream using Android Creator Mode..."
        
        # We use 'android_creator' (YouTube Studio App). 
        # YouTube is very reluctant to block this client.
        STREAM_URL=$(python3 -m yt_dlp --extractor-args "youtube:player_client=android_creator" -f 94/93/95/best -g "$YOUTUBE_URL")
        
        if [ -z "$STREAM_URL" ]; then
           echo "âŒ Failed to find stream. Trying backup 'android' client..."
           # Backup: Try standard Android client if Creator fails
           STREAM_URL=$(python3 -m yt_dlp --extractor-args "youtube:player_client=android" -f 94/93/95/best -g "$YOUTUBE_URL")
        fi
        
        if [ -z "$STREAM_URL" ]; then
           echo "âŒ All attempts failed."
           exit 1
        fi

        echo "âœ… Found Stream!"
        echo "STREAM_URL=$STREAM_URL" >> $GITHUB_ENV

    # 4. Start Capture (Cropped)
    - name: Capture Screenshots
      run: |
        echo "ðŸ“¸ Starting Capture..."
        
        # Capture command (Cropped Bottom Bar)
        ffmpeg -headers "User-Agent: Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Mobile Safari/537.36" -i "$STREAM_URL" -vf "fps=0.4,scale=854:480,crop=854:120:0:360" -t ${{ inputs.duration }} -q:v 5 screenshot_%04d.jpg

    # 5. Save Evidence
    - name: Upload Evidence
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: thanthi-tv-evidence
        path: "*.jpg"
