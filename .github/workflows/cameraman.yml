name: News Cameraman

on: 
  workflow_dispatch:
    inputs:
      duration:
        description: 'How long to watch? (seconds)'
        default: '3600'

jobs:
  watch-news:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - uses: actions/checkout@v3

    # 1. Install Tools (Added Node.js to fix the JS warning)
    - name: Install Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg nodejs
        sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
        sudo chmod a+rx /usr/local/bin/yt-dlp

    # 2. Find the Stream (Using Android Spoofing)
    - name: Get Stream URL
      id: get_stream
      run: |
        # Thanthi TV Permanent Live Link
        YOUTUBE_URL="https://www.youtube.com/@ThanthiTV/live"
        
        echo "ðŸ” Looking for stream..."
        
        # FIX: We tell YouTube we are an 'Android' phone, not a web browser.
        # This usually bypasses the "Sign in to confirm" error.
        STREAM_URL=$(yt-dlp --extractor-args "youtube:player_client=android" -f 94/93/95/best -g "$YOUTUBE_URL")
        
        echo "âœ… Found Stream!"
        echo "STREAM_URL=$STREAM_URL" >> $GITHUB_ENV

    # 3. Start Capture
    - name: Capture Screenshots
      run: |
        echo "ðŸ“¸ Starting Capture for ${{ inputs.duration }} seconds..."
        
        # Using the discovered stream URL
        ffmpeg -i "$STREAM_URL" \
        -vf "fps=0.4,scale=854:480" \
        -t ${{ inputs.duration }} \
        -q:v 5 \
        screenshot_%04d.jpg

    # 4. Save Evidence
    - name: Upload Evidence
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: thanthi-tv-evidence
        path: "*.jpg"
