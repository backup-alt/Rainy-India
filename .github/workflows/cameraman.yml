name: News Cameraman (Authenticated)

on: 
  workflow_dispatch:
    inputs:
      duration:
        description: 'How long to watch? (seconds)'
        default: '3600'

jobs:
  watch-news:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - uses: actions/checkout@v3

    # 1. Install Tools
    - name: Install Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg nodejs
        sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
        sudo chmod a+rx /usr/local/bin/yt-dlp

    # 2. Create the Cookie File from the Secret
    - name: Create Cookie File
      run: |
        echo "${{ secrets.YOUTUBE_COOKIES }}" > cookies.txt

    # 3. Find the Stream (Using Cookies to Login)
    - name: Get Stream URL
      id: get_stream
      run: |
        YOUTUBE_URL="https://www.youtube.com/@ThanthiTV/live"
        echo "ðŸ” Logging in and looking for stream..."
        
        # We pass --cookies cookies.txt to prove we are human
        STREAM_URL=$(yt-dlp --cookies cookies.txt -f 94/93/95/best -g "$YOUTUBE_URL")
        
        echo "âœ… Found Stream!"
        echo "STREAM_URL=$STREAM_URL" >> $GITHUB_ENV

    # 4. Start Capture
    - name: Capture Screenshots
      run: |
        echo "ðŸ“¸ Starting Capture..."
        
        # Note: We pass cookies to ffmpeg too via headers just in case
        ffmpeg -headers "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)" \
        -i "$STREAM_URL" \
        -vf "fps=0.4,scale=854:480" \
        -t ${{ inputs.duration }} \
        -q:v 5 \
        screenshot_%04d.jpg

    # 5. Cleanup & Save
    - name: Cleanup Secrets
      if: always()
      run: rm cookies.txt # Delete the key immediately after use

    - name: Upload Evidence
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: thanthi-tv-evidence
        path: "*.jpg"
