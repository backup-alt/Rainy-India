name: India News Monitor (100% Cloud Automation)

on:
  workflow_dispatch:
  schedule:
    - cron: '15,45 * * * *'

jobs:
  monitor:
    runs-on: ubuntu-latest # THIS replaces your laptop
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        include: [
          { name: "Thanthi", id: "j1nzTy5q_1Y" },
          { name: "Polimer", id: "Ei6NUWLQCQM" }
        ]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          python3 -m pip install yt-dlp

      - name: Capture and Signal
        env:
          ZOHO_CODE: ${{ secrets.ZOHO_DIGEST }} # Securely pulls your secret
        run: |
          NAME="${{ matrix.name }}"
          ID="${{ matrix.id }}"
          
          # 1. Get Stream URL
          URL=$(python3 -m yt_dlp -f best -g "https://www.youtube.com/watch?v=$ID" --no-warnings)

          if [ ! -z "$URL" ]; then
              # 2. Capture 15 seconds of news
              ffmpeg -i "$URL" -vf "fps=0.4,scale=800:-1,crop=800:100:0:380" -t 15 -q:v 5 "shot_%03d.jpg"
              
              # 3. Send to Zoho
              for img in shot_*.jpg; do
                  b64_data=$(base64 -w 0 "$img")
                  curl -X POST "https://api.catalyst.zoho.in/signals/v2/event_notification?digest=$ZOHO_CODE" \
                  -H "Content-Type: application/json" \
                  -d "{\"data\": {\"image\": \"$b64_data\", \"channel\": \"$NAME\"}}"
                  sleep 2
              done
          fi

      - name: Save Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-shots
          path: shot_*.jpg
          retention-days: 1
