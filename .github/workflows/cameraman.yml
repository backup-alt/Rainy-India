name: India News Monitor (Diagnostic Mode)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Seconds'
        default: '10'

jobs:
  setup:
    runs-on: self-hosted
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Load and Debug JSON
        id: set-matrix
        shell: powershell
        run: |
          # 1. Read raw content
          $RawContent = Get-Content "channels.json" -Raw
          Write-Host "DEBUG: Raw channels.json content follows:"
          Write-Host $RawContent
          
          # 2. Parse and re-compress to ensure it is clean JSON
          $json = $RawContent | ConvertFrom-Json | ConvertTo-Json -Compress
          
          # 3. Output for the next job
          echo "matrix=$json" >> $env:GITHUB_OUTPUT

  monitor:
    needs: setup
    runs-on: self-hosted
    strategy:
      # We remove fail-fast and max-parallel temporarily to simplify the block
      matrix:
        channel: ${{ fromJson(needs.setup.outputs.matrix) }}

    steps:
      - name: Debug Matrix Data
        shell: powershell
        run: |
          Write-Host "DEBUG: Received Object Name: ${{ matrix.channel.name }}"
          Write-Host "DEBUG: Received Object ID: ${{ matrix.channel.id }}"

      - name: Isolated Capture
        shell: powershell
        run: |
          $Name = "${{ matrix.channel.name }}"
          $ID = "${{ matrix.channel.id }}"
          $Dir = "diag_$Name"
          
          # Create isolated workspace to stop .exe and temp folder errors
          if (Test-Path $Dir) { Remove-Item $Dir -Recurse -Force }
          New-Item -ItemType Directory -Path $Dir -Force
          Set-Location $Dir

          Write-Host "Processing $Name via ID: $ID"
          
          # Resolve stream directly
          $Url = python -m yt_dlp -f best -g "https://www.youtube.com/watch?v=$ID" --no-warnings

          if ($Url) {
              ffmpeg -i "$Url" -vf "fps=0.4,scale=800:-1,crop=800:100:0:380" -t ${{ github.event.inputs.duration }} -q:v 5 "shot_%03d.jpg"
              Write-Host "SUCCESS: Captured frames in $Dir"
          } else {
              Write-Error "FAILURE: Could not connect to ID $ID"
          }
