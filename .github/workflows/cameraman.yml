name: India News Monitor (Final Cloud Version)

on:
  workflow_dispatch:
  schedule:
    - cron: '15,45 * * * *'

jobs:
  monitor:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        include:
          - { name: "Thanthi", id: "j1nzTy5q_1Y" }
          - { name: "Polimer", id: "Ei6NUWLQCQM" }
          - { name: "SunNews", id: "GNcDkMTBnx4" }
          - { name: "News18Tamil", id: "WkUMroKX7_c" }

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          # We force update yt-dlp to get the latest bot-bypass patches
          python3 -m pip install -U yt-dlp

      - name: Capture and Signal
        env:
          ZOHO_CODE: ${{ secrets.ZOHO_DIGEST }}
          COOKIES: ${{ secrets.YT_COOKIES }}
          UA: ${{ secrets.USER_AGENT }}
          PO: ${{ secrets.PO_DATA }}
        run: |
          NAME="${{ matrix.name }}"
          ID="${{ matrix.id }}"
          
          # 1. Create temporary cookies file
          echo "$COOKIES" > youtube_cookies.txt

          # 2. Advanced Bypass Capture
          # We use 'android' and 'ios' clients which are often less restricted
          # The po_token is passed via extractor-args
          URL=$(python3 -m yt_dlp \
            --cookies youtube_cookies.txt \
            --user-agent "$UA" \
            --extractor-args "youtube:player_client=android,ios;po_token=$PO" \
            -f best -g "https://www.youtube.com/watch?v=$ID" --no-warnings)

          if [ ! -z "$URL" ]; then
              echo "--- Successfully extracted stream for $NAME ---"
              
              # Capture 15 seconds, scale and crop to news ticker area
              ffmpeg -i "$URL" -vf "fps=0.4,scale=800:-1,crop=800:100:0:380" -t 15 -q:v 5 "shot_%03d.jpg"
              
              # 3. Send to Zoho Signal
              for img in shot_*.jpg; do
                  b64_data=$(base64 -w 0 "$img")
                  curl -X POST "https://api.catalyst.zoho.in/signals/v2/event_notification?digest=$ZOHO_CODE" \
                  -H "Content-Type: application/json" \
                  -d "{\"data\": {\"image\": \"$b64_data\", \"channel\": \"$NAME\"}}"
                  sleep 2
              done
          else
              echo "Error: YouTube Bot Detection blocked the stream for $NAME."
              echo "Check if your PO_TOKEN or COOKIES are still fresh."
              exit 1
          fi
          
          rm youtube_cookies.txt

      - name: Backup Artifacts
        if: always() # Run even if capture fails to check for debug logs
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-shots
          path: "*.jpg"
          retention-days: 1
